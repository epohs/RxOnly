(()=>{(function(){"use strict";var e=window.RxOnly={},t={fast_poll_interval:1e4,slow_poll_interval:2e4,scroll_debounce_delay:2e3,max_poll_failures:3,search_debounce_delay:300},n={current_view:"home",current_channel_index:null,current_channel_name:null,current_channel_url:null,current_node_url:null,breadcrumbs:[{label:"Dashboard",href:"/",view:"home"}],is_loading_more_nodes:!1,previous_view:null,previous_channel_index:null,previous_channel_name:null,previous_channel_url:null,fast_poll_timer:null,slow_poll_timer:null,poll_failure_count:0,known_local_node_id:null,known_first_seen:null,nodes_scroll_timeout:null,nodes_scroll_paused:!1,messages_scroll_timeout:null,messages_scroll_paused:!1,messages_has_more_older:!1,messages_has_more_newer:!1,messages_is_loading:!1,messages_oldest_rx_time:null,messages_newest_rx_time:null,messages_oldest_id:null,messages_newest_id:null,messages_is_dm:!1,messages_total:0,nodes_search_query:"",nodes_search_debounce_timeout:null,nodes_search_request_id:0,total_nodes:0,cached_local_node_name:null,saved_messages_scroll_top:null,saved_messages_is_mobile:!1,saved_messages_channel_index:null,saved_messages_is_dm:!1,navigating_from_content:!1,breadcrumb_last_scroll_y:0,breadcrumb_scroll_up_distance:0,breadcrumb_scroll_down_distance:0,breadcrumb_is_sticky:!1},C={body:document.body,app_layout:document.querySelector(".app-layout"),breadcrumbs_list:document.querySelector(".breadcrumbs ol"),main_content:document.getElementById("main-content"),nodes_list:document.querySelector(".nodes-list"),nodes_count:document.querySelector(".node-count"),channels_list:document.querySelector(".channels-list"),nodes_list_heading:document.getElementById("nodes-heading"),nodes_search_input:document.getElementById("nodes-search-input"),nodes_search_clear:document.getElementById("nodes-search-clear")};function P(a){return a?a.long_name?a.long_name:a.short_name?a.short_name:a.node_id?a.node_id:"":""}function D(a){if(!a||!a.local_node){document.title="RxOnly";return}var l=P(a.local_node),c=a.stats?a.stats.total_nodes:0;n.cached_local_node_name=l,l?document.title=l+" ("+c+")":document.title="RxOnly"}function J(a){n.total_nodes=a,n.cached_local_node_name&&(document.title=n.cached_local_node_name+" ("+a+")"),C.nodes_count&&n.nodes_search_query.trim()===""&&(C.nodes_count.textContent="("+a+")"),C.nodes_list&&(C.nodes_list.dataset.total=a);var l=document.getElementById("dashboard-stat-nodes");l&&(l.textContent=a)}function z(){return C.body.dataset.apiNodeUrlTemplate||"/api/nodes/__NODE_ID__"}function Q(a){return z().replace("__NODE_ID__",encodeURIComponent(a))}function Z(a,l){if(l){var c=C.body.dataset.apiDmUrlTemplate||"/api/direct-messages/__MESSAGE_ID__";return c.replace("__MESSAGE_ID__",encodeURIComponent(a))}var u=C.body.dataset.apiMessageUrlTemplate||"/api/messages/__MESSAGE_ID__";return u.replace("__MESSAGE_ID__",encodeURIComponent(a))}function O(a){if(!a)return"";var l=new Date(a*1e3);return l.toLocaleString()}function W(a){if(!a)return"";var l=new Date(a*1e3);return l.toISOString()}function y(a){var l=document.createElement("div");return l.textContent=a,l.innerHTML}function q(a){return a.long_name&&a.short_name?a.long_name+" ("+a.short_name+")":a.long_name?a.long_name:a.short_name?a.short_name:a.node_id}function L(a){var l=a.long_name||a.from_node_long_name,c=a.short_name||a.from_node_short_name,u=a.node_id||a.from_node;return l&&c?'<span class="node-long-name">'+y(l)+'</span> <span class="node-short-name">('+y(c)+")</span>":l?'<span class="node-long-name">'+y(l)+"</span>":c?'<span class="node-short-name">'+y(c)+"</span>":u?'<span class="node-id">'+y(u)+"</span>":'<span class="node-id">Unknown</span>'}function F(a,l){return l.split(".").reduce(function(c,u){return c?.[u]},a)}function N(a,l,c){for(var u=Object.entries(c),b=0;b<u.length;b++){var B=u[b][0],$=u[b][1],X=a.querySelector($.selector);if(X){var G;if($.compute?G=$.compute(l):G=F(l,B),G==null||G===""){var K=X.closest("tr");K&&K.setAttribute("hidden","");continue}$.format&&(G=$.format(G)),$.html?X.innerHTML=String(G):X.textContent=String(G);var ee=X.closest("tr");ee&&ee.removeAttribute("hidden")}}}function I(a,l,c){var u=document.getElementById(a);if(!u)return null;var b=u.content.cloneNode(!0);return N(b,l,c),b}function T(a,l,c){a&&N(a,l,c)}var Y={dashboard:{"local_node.node_id":{selector:"[data-field='node-id']"},"local_node.hardware":{selector:"[data-field='hardware']"},"local_node.role":{selector:"[data-field='role']"},"local_node.first_seen":{selector:"[data-field='first-seen']",format:O},"local_node.last_seen":{selector:"[data-field='last-seen']",format:O},"local_node.battery_level":{selector:"[data-field='battery']",format:function(a){return a+"%"}},"local_node.voltage":{selector:"[data-field='voltage']",format:function(a){return a+"V"}},"stats.total_nodes":{selector:"#dashboard-stat-nodes"},"stats.total_messages":{selector:"#dashboard-stat-messages"},"stats.total_direct_messages":{selector:"#dashboard-stat-dms"},"stats.total_channels":{selector:"#dashboard-stat-channels"}},node_detail:{node_id:{selector:"[data-field='node-id']"},short_name:{selector:"[data-field='short-name']"},long_name:{selector:"[data-field='long-name']"},hardware:{selector:"[data-field='hardware']"},role:{selector:"[data-field='role']"},first_seen:{selector:"[data-field='first-seen']",format:O},last_seen:{selector:"[data-field='last-seen']",format:O},battery_level:{selector:"[data-field='battery']",format:function(a){return a+"%"}},voltage:{selector:"[data-field='voltage']",format:function(a){return a+"V"}},snr:{selector:"[data-field='snr']"},rssi:{selector:"[data-field='rssi']"},latitude:{selector:"[data-field='latitude']"},longitude:{selector:"[data-field='longitude']"},altitude:{selector:"[data-field='altitude']",format:function(a){return a+"m"}}},message_item:{_from_display:{selector:"[data-field='from-node']",compute:L,html:!0},rx_time:{selector:"[data-field='rx-time']",format:O},text:{selector:"[data-field='text']"}},message_detail:{message_id:{selector:"[data-field='message-id']"},_from_display:{selector:"[data-field='from-node']",compute:L,html:!0},to_node:{selector:"[data-field='to-node']"},reply_to:{selector:"[data-field='reply-to']"},text:{selector:"[data-field='text']"},rx_time:{selector:"[data-field='rx-time']",format:O},_channel_display:{selector:"[data-field='channel']",compute:function(a){return a.channel_name||(a.channel_index!=null?"Channel "+a.channel_index:null)}},hop_count:{selector:"[data-field='hop-count']"},snr:{selector:"[data-field='snr']"},rssi:{selector:"[data-field='rssi']"},_via_mqtt:{selector:"[data-field='via-mqtt']",compute:function(a){return a.via_mqtt?"Yes":"No"}}}};function M(a){if(!a)return null;var l=a.getBoundingClientRect(),c=a.querySelectorAll("li");if(c.length===0)return null;for(var u=0;u<c.length;u++){var b=c[u].getBoundingClientRect();if(b.top>=l.top-10)return{element:c[u],offset_from_top:b.top-l.top}}return null}function A(a,l){if(!(!a||!l||!l.element)&&a.contains(l.element)){var c=a.getBoundingClientRect(),u=l.element.getBoundingClientRect(),b=u.top-c.top,B=b-l.offset_from_top;a.scrollTop+=B}}function w(a){return a?a.scrollTop<10:!0}var R=80;function V(){var a=window.scrollY,l=n.breadcrumb_last_scroll_y,c=a-l;if(a<=0){n.breadcrumb_scroll_up_distance=0,n.breadcrumb_scroll_down_distance=0,n.breadcrumb_is_sticky=!1,C.body.classList.remove("breadcrumbs-sticky","breadcrumbs-hiding"),n.breadcrumb_last_scroll_y=a;return}c>0?n.breadcrumb_is_sticky?(n.breadcrumb_scroll_down_distance+=c,n.breadcrumb_scroll_up_distance=0,n.breadcrumb_scroll_down_distance>=R&&(n.breadcrumb_scroll_down_distance=0,n.breadcrumb_is_sticky=!1,C.body.classList.add("breadcrumbs-hiding"))):(n.breadcrumb_scroll_up_distance=0,n.breadcrumb_scroll_down_distance=0):c<0&&(n.breadcrumb_scroll_up_distance+=Math.abs(c),n.breadcrumb_scroll_down_distance=0,n.breadcrumb_scroll_up_distance>=R&&(C.body.classList.contains("breadcrumbs-hiding")?(C.body.classList.remove("breadcrumbs-hiding"),n.breadcrumb_is_sticky=!0):n.breadcrumb_is_sticky||(n.breadcrumb_is_sticky=!0,C.body.classList.add("breadcrumbs-sticky","breadcrumbs-hiding"),C.body.offsetHeight,C.body.classList.remove("breadcrumbs-hiding")))),n.breadcrumb_last_scroll_y=a}function j(a,l){return a?"rxonly_last_read_dm":"rxonly_last_read_ch_"+l}function U(a,l){try{var c=j(a,l),u=localStorage.getItem(c);if(!u)return null;var b=JSON.parse(u);return b&&typeof b.message_id=="number"&&typeof b.rx_time=="number"?b:null}catch{return null}}function o(a,l,c,u){try{var b=j(a,l);localStorage.setItem(b,JSON.stringify({message_id:c,rx_time:u}))}catch{}}function m(){var a=document.getElementById("messages-list");if(a){for(var l=a.getBoundingClientRect(),c=l.bottom,u=a.querySelectorAll("li[data-message-id]"),b=null,B=0;B<u.length;B++){var $=u[B].getBoundingClientRect();if($.top<c)b=u[B],h(u[B]);else break}if(b){var X=parseInt(b.dataset.messageId,10),G=parseInt(b.dataset.rxTime||"0",10);if(X&&G){var K=U(n.messages_is_dm,n.current_channel_index);(!K||G>K.rx_time||G===K.rx_time&&X>K.message_id)&&o(n.messages_is_dm,n.current_channel_index,X,G)}}}}function h(a){a.classList.contains("message-read")||(a.classList.remove("message-unread"),a.classList.add("message-read"))}function p(a,l){if(l)for(var c=a.querySelectorAll("li[data-message-id]"),u=0;u<c.length;u++){var b=parseInt(c[u].dataset.rxTime||"0",10),B=parseInt(c[u].dataset.messageId,10);(b<l.rx_time||b===l.rx_time&&B<=l.message_id)&&h(c[u])}}function v(){if(!(n.current_view!=="channel"&&n.current_view!=="direct_messages")){m();var a=document.getElementById("messages-list");if(a){var l=getComputedStyle(a).overflowY==="visible",c=l?window.scrollY:a.scrollTop;c>0&&(n.saved_messages_scroll_top=c,n.saved_messages_is_mobile=l,n.saved_messages_channel_index=n.current_channel_index,n.saved_messages_is_dm=n.current_view==="direct_messages")}}}function E(){n.saved_messages_scroll_top=null,n.saved_messages_is_mobile=!1,n.saved_messages_channel_index=null,n.saved_messages_is_dm=!1}function H(a,l){if(n.saved_messages_scroll_top===null)return null;if(n.saved_messages_is_dm!==a||!a&&n.saved_messages_channel_index!==l)return E(),null;var c={scroll_top:n.saved_messages_scroll_top,is_mobile:n.saved_messages_is_mobile};return E(),c}function s(){return C.body.dataset.apiNodesUrl||"/api/nodes"}function r(){return C.body.dataset.apiStatsUrl||"/api/stats"}function _(a,l,c){var u=s(),b=u+"?offset="+a+"&limit="+l;return c&&(b+="&search="+encodeURIComponent(c)),fetch(b).then(function(B){if(!B.ok)throw new Error("Failed to fetch nodes: "+B.status);return B.json()})}function d(){var a=r();return fetch(a).then(function(l){if(!l.ok)throw new Error("Failed to fetch stats: "+l.status);return l.json()})}function i(a){var l=a.is_dm||!1,c=s().replace("/nodes",l?"/direct-messages":"/messages"),u=new URLSearchParams;!l&&a.channel_index!=null&&u.set("channel_index",String(a.channel_index)),a.after_rx_time!=null&&u.set("after_rx_time",String(a.after_rx_time)),a.before_rx_time!=null&&u.set("before_rx_time",String(a.before_rx_time)),a.newest&&u.set("newest","1"),u.set("limit",String(a.limit||50));var b=c+"?"+u.toString();return fetch(b).then(function(B){if(!B.ok)throw new Error("Failed to fetch "+(l?"direct messages":"messages")+": "+B.status);return B.json()})}function f(a,l){var c=l?a.direct_messages:a.messages;if(n.messages_has_more_older=a.meta.has_more_older,n.messages_has_more_newer=a.meta.has_more_newer,n.messages_total=a.meta.total,c.length>0){var u=c[0],b=c[c.length-1];(n.messages_oldest_rx_time===null||u.rx_time<n.messages_oldest_rx_time||u.rx_time===n.messages_oldest_rx_time&&u.id<n.messages_oldest_id)&&(n.messages_oldest_rx_time=u.rx_time,n.messages_oldest_id=u.id),(n.messages_newest_rx_time===null||b.rx_time>n.messages_newest_rx_time||b.rx_time===n.messages_newest_rx_time&&b.id>n.messages_newest_id)&&(n.messages_newest_rx_time=b.rx_time,n.messages_newest_id=b.id)}}function g(){n.messages_has_more_older=!1,n.messages_has_more_newer=!1,n.messages_is_loading=!1,n.messages_oldest_rx_time=null,n.messages_newest_rx_time=null,n.messages_oldest_id=null,n.messages_newest_id=null,n.messages_total=0,e.clear_pending_tapbacks()}function x(){var a=n.breadcrumbs.map(function(l,c){var u=c===n.breadcrumbs.length-1;return u?'<li><a href="'+l.href+'" aria-current="page" data-view="'+l.view+'">'+y(l.label)+"</a></li>":'<li><a href="'+l.href+'" data-view="'+l.view+'">'+y(l.label)+"</a></li>"}).join("");C.breadcrumbs_list.innerHTML=a}function S(a){n.breadcrumbs=a,x()}function k(){for(var a=document.querySelectorAll(".channel-link.active, .node-link.active"),l=0;l<a.length;l++)a[l].classList.remove("active")}e.config=t,e.app_state=n,e.dom_elements=C,e.field_maps=Y,e.update_page_title=D,e.update_all_node_counts=J,e.format_timestamp=O,e.format_iso_timestamp=W,e.escape_html=y,e.build_node_url=Q,e.build_message_url=Z,e.format_node_display_name=q,e.format_node_display_html=L,e.get_nested_value=F,e.populate_template=I,e.populate_fragment=N,e.update_element=T,e.get_scroll_anchor=M,e.restore_scroll_anchor=A,e.is_at_scroll_top=w,e.handle_breadcrumb_scroll=V,e.get_last_read=U,e.set_last_read=o,e.update_read_position=m,e.mark_message_read=h,e.mark_read_up_to=p,e.save_read_position_before_leave=v,e.clear_saved_scroll_position=E,e.consume_saved_scroll_position=H,e.get_nodes_list_url=s,e.get_stats_url=r,e.fetch_nodes_page=_,e.fetch_stats=d,e.fetch_message_page=i,e.update_message_cursors=f,e.reset_message_state=g,e.set_breadcrumbs=S,e.clear_sidebar_active=k})(),function(){"use strict";var e=window.RxOnly,t=e.app_state,n=e.dom_elements,C=e.config,P=e.field_maps,D=new Map;function J(s){if(!s)return!1;var r=s.trim();if(r.length===0)return!1;var _=new Intl.Segmenter(void 0,{granularity:"grapheme"}),d=Array.from(_.segment(r));if(d.length<1||d.length>3)return!1;for(var i=/\p{Extended_Pictographic}/u,f=0;f<d.length;f++)if(!i.test(d[f].segment))return!1;return!0}function z(s){return s.reply_to!=null&&J(s.text)}function Q(){D.clear()}function Z(s){var r=String(s.reply_to);D.has(r)||D.set(r,[]),D.get(r).push(s)}function O(s,r){var _=document.createElement("a");_.className="tapback-pill",_.href=e.build_message_url(s.message_id,r),_.dataset.tapbackId=String(s.message_id);var d=document.createElement("span");if(d.className="tapback-emoji",d.textContent=s.text.trim(),_.appendChild(d),s.from_node_short_name){var i=document.createElement("span");i.className="tapback-author",i.textContent=s.from_node_short_name,_.appendChild(i)}return _}function W(s,r){var _=document.createElement("span");_.className="tapback-pill tapback-grouped";var d=document.createElement("span");d.className="tapback-emoji",d.textContent=s,_.appendChild(d);var i=document.createElement("span");return i.className="tapback-count",i.textContent=String(r),_.appendChild(i),_}function y(s,r,_){if(s.innerHTML="",r.length!==0){r.sort(function(k,a){return(k.rx_time||0)-(a.rx_time||0)});var d=new Map;r.forEach(function(k){var a=k.text.trim();d.has(a)||d.set(a,[]),d.get(a).push(k)});var i=[],f=10;d.forEach(function(k,a){k.length>5?i.push(W(a,k.length)):k.forEach(function(l){i.push(O(l,_))})});var g=i.length-f,x=g>0?i.slice(0,f):i;if(x.forEach(function(k){s.appendChild(k)}),g>0){var S=document.createElement("span");S.className="tapback-pill tapback-overflow",S.textContent="+"+g+" more",s.appendChild(S)}}}function q(s,r){var _=String(s.reply_to),d=document.querySelector('#messages-list li[data-message-id="'+_+'"]');if(!d)return!1;var i=d.querySelector(".tapback-container");if(!i){var f=d.querySelector(".message-item");if(!f)return!1;i=document.createElement("div"),i.className="tapback-container",f.appendChild(i)}var g=[],x=i.querySelectorAll("[data-tapback-id]");if(x.forEach(function(a){g.push(a.dataset.tapbackId)}),g.indexOf(String(s.message_id))!==-1)return!0;var S=[];try{var k=i.dataset.tapbacks;k&&(S=JSON.parse(k))}catch{S=[]}return S.push(s),i.dataset.tapbacks=JSON.stringify(S),y(i,S,r),!0}function L(s){if(D.size!==0){var r=[];D.forEach(function(_,d){var i=document.querySelector('#messages-list li[data-message-id="'+d+'"]');i&&(_.forEach(function(f){q(f,s)}),r.push(d))}),r.forEach(function(_){D.delete(_)})}}function F(s,r){if(!s)return"";r=r||120;var _=s.replace(/\n/g," ").replace(/ {2,}/g," ").trim();return _.length<=r?_:_.substring(0,r)+"\u2026"}function N(s,r){var _=e.populate_template("template-message-item",s,P.message_item);if(!_)return null;var d=_.querySelector(".message-from");if(d){var i=s.from_node_long_name||s.from_node_short_name;if(i&&s.from_node)d.href=e.build_node_url(s.from_node),d.dataset.nodeId=s.from_node;else{var f=document.createElement("span");f.className="message-from node-unknown",f.textContent=d.textContent,d.parentNode.replaceChild(f,d)}}var g=_.querySelector(".message-time-link");g&&s.message_id&&(g.href=e.build_message_url(s.message_id,r));var x=_.querySelector(".message-time");if(x&&s.rx_time&&x.setAttribute("datetime",e.format_iso_timestamp(s.rx_time)),s.reply_to!=null&&!z(s)&&s.reply_to_text!=null){var S=_.querySelector(".message-reply-bar");if(S){var k=s.reply_to_from_node_short_name||s.reply_to_from_node||"Unknown",a=F(s.reply_to_text),l=S.querySelector(".message-reply-bar-text");l&&(l.innerHTML='<strong class="message-reply-author">Reply to:</strong> '+e.escape_html(k)+' - <em class="message-reply-excerpt">'+e.escape_html(a)+"</em>"),S.href=e.build_message_url(s.reply_to,r),S.dataset.replyToId=String(s.reply_to),S.removeAttribute("hidden")}}var c=_.querySelector("li");return c&&(c.dataset.messageId=String(s.message_id),s.rx_time!=null&&(c.dataset.rxTime=String(s.rx_time))),_}function I(){var s=document.getElementById("jump-to-newest");s&&(t.messages_has_more_newer?s.removeAttribute("hidden"):s.setAttribute("hidden",""))}function T(s,r,_){var d=[],i=[];r.forEach(function(g){z(g)?i.push(g):d.push(g)});var f=document.createDocumentFragment();d.forEach(function(g){var x=N(g,_);x&&f.appendChild(x)}),s.appendChild(f),i.forEach(function(g){q(g,_)||Z(g)}),L(_)}function Y(s,r,_){var d=getComputedStyle(s).overflowY==="visible",i=d?document.documentElement.scrollHeight:s.scrollHeight,f=[],g=[];r.forEach(function(c){z(c)?g.push(c):f.push(c)});var x=document.createDocumentFragment();f.forEach(function(c){var u=N(c,_);u&&x.appendChild(u)});for(var S=x.querySelectorAll("li[data-message-id]"),k=0;k<S.length;k++)e.mark_message_read(S[k]);s.insertBefore(x,s.firstChild),g.forEach(function(c){q(c,_)||Z(c)}),L(_);var a=d?document.documentElement.scrollHeight:s.scrollHeight,l=a-i;d?window.scrollBy(0,l):s.scrollTop+=l}function M(s,r,_){var d=e.populate_template("template-messages-list",{},{});if(d){var i=d.querySelector("[data-field='heading']");i&&(i.textContent=s);var f=d.querySelector("#messages-list");f&&T(f,r,_),n.main_content.innerHTML="",n.main_content.appendChild(d),L(_),I()}}async function A(s){var r=s.is_dm,_=s.channel_index,d=s.heading;e.reset_message_state(),t.messages_is_dm=r,n.main_content.innerHTML="<p>Loading...</p>";try{var i=e.get_last_read(r,_);if(i){var f=await e.fetch_message_page({is_dm:r,channel_index:_,before_rx_time:i.rx_time+1}),g=r?f.direct_messages:f.messages;if(g.length===0){await w(r,_,d);return}var x=await e.fetch_message_page({is_dm:r,channel_index:_,after_rx_time:i.rx_time}),S=r?x.direct_messages:x.messages,k=g.concat(S);e.update_message_cursors(f,r),e.update_message_cursors(x,r),t.messages_has_more_newer=x.meta.has_more_newer,t.messages_has_more_older=f.meta.has_more_older,M(d,k,r);var a=document.getElementById("messages-list");a&&e.mark_read_up_to(a,i);var l=e.consume_saved_scroll_position(r,_);l!==null&&a?l.is_mobile?window.scrollTo(0,l.scroll_top):a.scrollTop=l.scroll_top:R(i.message_id)}else await w(r,_,d)}catch(u){var c=r?"direct messages":"messages";n.main_content.innerHTML='<p class="error-state">Error loading '+c+": "+e.escape_html(u.message)+"</p>"}}async function w(s,r,_){var d=await e.fetch_message_page({is_dm:s,channel_index:r,newest:!0}),i=s?d.direct_messages:d.messages;if(i.length===0){var f=e.populate_template("template-messages-empty",{},{});if(f){var g=f.querySelector("[data-field='heading']");g&&(g.textContent=_),n.main_content.innerHTML="",n.main_content.appendChild(f)}return}e.update_message_cursors(d,s),M(_,i,s);var x=document.getElementById("messages-list");if(x)for(var S=x.querySelectorAll("li[data-message-id]"),k=0;k<S.length;k++)e.mark_message_read(S[k]);if(i.length>0){var a=i[i.length-1];e.set_last_read(s,r,a.message_id,a.rx_time)}x&&(x.scrollTop=x.scrollHeight)}function R(s){var r=document.getElementById("messages-list");if(r){var _=r.querySelector('li[data-message-id="'+s+'"]');_&&_.scrollIntoView({block:"start"})}}function V(s){return n.channels_list?n.channels_list.querySelector('.channel-link[data-channel-index="'+s+'"]'):null}async function j(s,r,_){if(!V(_))return!1;e.save_read_position_before_leave(),t.current_view="channel",t.current_channel_index=_,t.current_channel_name=r,t.current_channel_url=s,t.current_node_url=null,n.app_layout.classList.add("viewing-detail"),e.clear_sidebar_active();var d=V(_);return d&&d.classList.add("active"),e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"},{label:r,href:s,view:"channel"}]),await A({is_dm:!1,channel_index:_,heading:r}),!0}async function U(s){if(e.save_read_position_before_leave(),t.current_view="direct_messages",t.current_channel_index=null,t.current_channel_name="Direct Messages",t.current_channel_url=s,t.current_node_url=null,n.app_layout.classList.add("viewing-detail"),e.clear_sidebar_active(),n.channels_list){var r=n.channels_list.querySelector('.channel-link[data-channel-index="dm"]');r&&r.classList.add("active")}e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"},{label:"Direct Messages",href:s,view:"direct_messages"}]),await A({is_dm:!0,channel_index:null,heading:"Direct Messages"})}async function o(s,r){e.save_read_position_before_leave(),t.previous_view=t.current_view,t.previous_channel_index=t.current_channel_index,t.previous_channel_name=t.current_channel_name,t.previous_channel_url=t.current_channel_url,t.current_view="message",t.current_node_url=null,n.app_layout.classList.add("viewing-detail"),n.main_content.innerHTML="<p>Loading...</p>";try{var _=e.build_message_url(s,r),d=await fetch(_),i=await d.json();if(!d.ok){var f=i.error||"Message not found";e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"}]),n.main_content.innerHTML='<p class="error-state">'+e.escape_html(f)+"</p>";return}var g=[{label:"Dashboard",href:"/",view:"home"}];if(t.previous_view==="channel"&&t.previous_channel_name)g.push({label:t.previous_channel_name,href:t.previous_channel_url,view:"channel"});else if(t.previous_view==="direct_messages")g.push({label:"Direct Messages",href:t.previous_channel_url,view:"direct_messages"});else if(r){var x=n.channels_list?n.channels_list.querySelector('.channel-link[data-channel-index="dm"]'):null;x&&g.push({label:"Direct Messages",href:x.getAttribute("href"),view:"direct_messages"})}else if(i.channel_index!=null){var S=i.channel_name||"Channel "+i.channel_index,k=n.channels_list?n.channels_list.querySelector('.channel-link[data-channel-index="'+i.channel_index+'"]'):null,a=k?k.getAttribute("href"):"#";g.push({label:S,href:a,view:"channel"})}g.push({label:"Message",href:"#",view:"message"}),e.set_breadcrumbs(g);var l=e.populate_template("template-message-detail",i,P.message_detail);if(l){var c=l.querySelector(".message-detail-from");c&&i.from_node&&(c.href=e.build_node_url(i.from_node),c.dataset.nodeId=i.from_node);var u=l.querySelector(".message-detail-reply-to");u&&i.reply_to!=null&&(u.href=e.build_message_url(i.reply_to,r),u.dataset.replyToId=String(i.reply_to)),n.main_content.innerHTML="",n.main_content.appendChild(l)}}catch{e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"}]),n.main_content.innerHTML='<p class="error-state">Error loading message</p>'}}async function m(){var s=document.getElementById("messages-list");if(!(!s||t.messages_is_loading)){t.messages_is_loading=!0,Q();try{var r=t.messages_is_dm,_=t.current_channel_index,d=await e.fetch_message_page({is_dm:r,channel_index:_,newest:!0}),i=r?d.direct_messages:d.messages;t.messages_oldest_rx_time=null,t.messages_newest_rx_time=null,t.messages_oldest_id=null,t.messages_newest_id=null,e.update_message_cursors(d,r),s.innerHTML="",T(s,i,r);for(var f=s.querySelectorAll("li[data-message-id]"),g=0;g<f.length;g++)e.mark_message_read(f[g]);if(s.scrollTop=s.scrollHeight,i.length>0){var x=i[i.length-1];e.set_last_read(r,_,x.message_id,x.rx_time)}I()}catch(S){console.error("Jump to newest failed:",S)}finally{t.messages_is_loading=!1}}}async function h(){if(!(t.messages_is_loading||!t.messages_has_more_older)&&t.messages_oldest_rx_time!==null){var s=document.getElementById("messages-list");if(s){t.messages_is_loading=!0;try{var r=t.messages_is_dm,_=t.current_channel_index,d=await e.fetch_message_page({is_dm:r,channel_index:_,before_rx_time:t.messages_oldest_rx_time}),i=r?d.direct_messages:d.messages;if(i.length>0){t.messages_has_more_older=d.meta.has_more_older;var f=i[0];t.messages_oldest_rx_time=f.rx_time,t.messages_oldest_id=f.id,Y(s,i,r)}else t.messages_has_more_older=!1}catch(g){console.error("Load older messages failed:",g)}finally{t.messages_is_loading=!1}}}}async function p(){if(!(t.messages_is_loading||!t.messages_has_more_newer)&&t.messages_newest_rx_time!==null){var s=document.getElementById("messages-list");if(s){t.messages_is_loading=!0;try{var r=t.messages_is_dm,_=t.current_channel_index,d=await e.fetch_message_page({is_dm:r,channel_index:_,after_rx_time:t.messages_newest_rx_time}),i=r?d.direct_messages:d.messages;if(i.length>0){t.messages_has_more_newer=d.meta.has_more_newer;var f=i[i.length-1];t.messages_newest_rx_time=f.rx_time,t.messages_newest_id=f.id,T(s,i,r)}else t.messages_has_more_newer=!1;I()}catch(g){console.error("Load newer messages failed:",g)}finally{t.messages_is_loading=!1}}}}function v(){t.messages_scroll_paused=!0,t.messages_scroll_timeout&&clearTimeout(t.messages_scroll_timeout),t.messages_scroll_timeout=setTimeout(function(){t.messages_scroll_paused=!1},C.scroll_debounce_delay),e.update_read_position();var s=document.getElementById("messages-list");if(s&&s.scrollTop<100&&h(),s){var r=s.querySelector("li:last-child");if(r){var _=s.getBoundingClientRect(),d=r.getBoundingClientRect();d.bottom-_.bottom<200&&p()}}}function E(){if(!(t.current_view!=="channel"&&t.current_view!=="direct_messages")){var s=document.getElementById("messages-list");if(s&&getComputedStyle(s).overflowY==="visible"){t.messages_scroll_paused=!0,t.messages_scroll_timeout&&clearTimeout(t.messages_scroll_timeout),t.messages_scroll_timeout=setTimeout(function(){t.messages_scroll_paused=!1},C.scroll_debounce_delay),e.update_read_position();var r=s.querySelector("li:first-child");if(r){var _=r.getBoundingClientRect();_.top>-100&&h()}var d=s.querySelector("li:last-child");if(d){var i=d.getBoundingClientRect();i.bottom-window.innerHeight<200&&p()}}}}function H(){n.main_content.addEventListener("scroll",function(s){s.target.classList.contains("messages-list")&&v()},!0),n.main_content.addEventListener("click",function(s){var r=s.target.closest("#jump-to-newest");r&&(s.preventDefault(),m())})}e.clear_pending_tapbacks=Q,e.show_channel_messages=j,e.show_direct_messages=U,e.show_message_detail=o,e.append_messages_to_list=T,e.update_jump_to_newest_button=I,e.setup_messages_scroll_listener=H,e.handle_messages_window_scroll=E}(),function(){"use strict";var e=window.RxOnly,t=e.app_state,n=e.dom_elements,C=e.config;function P(y){var q=y.target.value.trim();t.nodes_search_debounce_timeout&&clearTimeout(t.nodes_search_debounce_timeout),t.nodes_search_debounce_timeout=setTimeout(function(){t.nodes_search_query=q,n.nodes_search_clear&&(q===""?n.nodes_search_clear.setAttribute("hidden",""):n.nodes_search_clear.removeAttribute("hidden")),D()},C.search_debounce_delay)}async function D(){var y=++t.nodes_search_request_id,q=t.nodes_search_query,L=n.nodes_list;if(L)try{var F=e.get_nodes_list_url(),N;q?N=F+"?search="+encodeURIComponent(q)+"&limit=1000":N=F+"?offset=0&limit=50";var I=await fetch(N);if(!I.ok)throw new Error("Search failed: "+I.status);if(y!==t.nodes_search_request_id)return;var T=await I.json(),Y=document.createDocumentFragment();if(T.nodes.forEach(function(w){var R=document.createElement("li"),V=e.build_node_url(w.node_id),j=document.createElement("a");j.href=V,j.dataset.nodeId=w.node_id,j.className="node-link";var U=document.createElement("span");if(U.className="node-name",U.innerHTML=e.format_node_display_html(w),j.appendChild(U),w.last_seen){var o=document.createElement("time");o.className="node-last-seen",o.setAttribute("datetime",e.format_iso_timestamp(w.last_seen)),o.textContent=e.format_timestamp(w.last_seen),j.appendChild(o)}R.appendChild(j),Y.appendChild(R)}),T.nodes.length===0){var M=document.createElement("li");M.className="empty-state",M.textContent=q?"No matching nodes":"No nodes",Y.appendChild(M)}var A=window.scrollY;L.innerHTML="",L.appendChild(Y),O()&&window.scrollTo(0,A),L.dataset.offset=String(T.nodes.length),L.dataset.total=String(T.meta.total),q?n.nodes_count.textContent="("+T.meta.total+" of "+t.total_nodes+")":e.update_all_node_counts(T.meta.total)}catch(w){console.error("Node search failed:",w)}}function J(){n.nodes_search_input&&(n.nodes_search_input.value=""),t.nodes_search_query="",n.nodes_search_clear&&n.nodes_search_clear.setAttribute("hidden",""),D(),n.nodes_search_input.focus()}async function z(){var y=n.nodes_list;if(y){var q=t.nodes_search_query.trim(),L=e.is_at_scroll_top(y),F=L?null:e.get_scroll_anchor(y);try{var N;if(q){var I=e.get_nodes_list_url(),T=await fetch(I+"?search="+encodeURIComponent(q)+"&limit=1000");if(!T.ok)throw new Error("Failed to fetch nodes");N=await T.json()}else{var Y=parseInt(y.dataset.offset,10)||50;N=await e.fetch_nodes_page(0,Y)}var M={};y.querySelectorAll("li").forEach(function(w){var R=w.querySelector(".node-link");R&&(M[R.dataset.nodeId]=w)});var A=document.createDocumentFragment();N.nodes.forEach(function(w){if(M[w.node_id]){var R=M[w.node_id],V=R.querySelector(".node-name"),j=R.querySelector(".node-last-seen");V&&(V.innerHTML=e.format_node_display_html(w)),j&&w.last_seen&&(j.textContent=e.format_timestamp(w.last_seen)),A.appendChild(R)}else{var U=document.createElement("li"),o=e.build_node_url(w.node_id),m=document.createElement("a");m.href=o,m.dataset.nodeId=w.node_id,m.className="node-link";var h=document.createElement("span");if(h.className="node-name",h.innerHTML=e.format_node_display_html(w),m.appendChild(h),w.last_seen){var p=document.createElement("time");p.className="node-last-seen",p.setAttribute("datetime",e.format_iso_timestamp(w.last_seen)),p.textContent=e.format_timestamp(w.last_seen),m.appendChild(p)}U.appendChild(m),A.appendChild(U)}}),y.innerHTML="",y.appendChild(A),q?n.nodes_count.textContent="("+N.meta.total+" of "+t.total_nodes+")":e.update_all_node_counts(N.meta.total),L?y.scrollTop=0:F&&e.restore_scroll_anchor(y,F)}catch(w){console.error("Failed to update nodes list:",w)}}}async function Q(){if(!t.is_loading_more_nodes&&t.nodes_search_query.trim()===""){var y=n.nodes_list,q=parseInt(y.dataset.offset,10)||0,L=parseInt(y.dataset.total,10)||0;if(!(q>=L)){t.is_loading_more_nodes=!0;try{var F=await e.fetch_nodes_page(q,50),N=document.createDocumentFragment();F.nodes.forEach(function(I){var T=document.createElement("li"),Y=e.build_node_url(I.node_id),M=document.createElement("a");M.href=Y,M.dataset.nodeId=I.node_id,M.className="node-link";var A=document.createElement("span");if(A.className="node-name",A.innerHTML=e.format_node_display_html(I),M.appendChild(A),I.last_seen){var w=document.createElement("time");w.className="node-last-seen",w.setAttribute("datetime",e.format_iso_timestamp(I.last_seen)),w.textContent=e.format_timestamp(I.last_seen),M.appendChild(w)}T.appendChild(M),N.appendChild(T)}),y.appendChild(N),y.dataset.offset=q+F.nodes.length}catch(I){console.error("Failed to load more nodes:",I)}finally{t.is_loading_more_nodes=!1}}}}function Z(){var y=n.nodes_list;if(t.nodes_scroll_paused=!0,t.nodes_scroll_timeout&&clearTimeout(t.nodes_scroll_timeout),t.nodes_scroll_timeout=setTimeout(function(){t.nodes_scroll_paused=!1},C.scroll_debounce_delay),t.nodes_search_query.trim()===""){var q=y.scrollTop+y.clientHeight,L=y.scrollHeight-100;q>=L&&Q()}}function O(){return n.nodes_list?getComputedStyle(n.nodes_list).overflowY==="visible":!1}function W(){if(O()&&t.nodes_search_query.trim()===""&&!n.app_layout.classList.contains("viewing-detail")){t.nodes_scroll_paused=!0,t.nodes_scroll_timeout&&clearTimeout(t.nodes_scroll_timeout),t.nodes_scroll_timeout=setTimeout(function(){t.nodes_scroll_paused=!1},C.scroll_debounce_delay);var y=window.scrollY+window.innerHeight,q=document.documentElement.scrollHeight;q-y<200&&Q()}}e.handle_nodes_search_input=P,e.fetch_and_render_nodes_search=D,e.clear_nodes_search=J,e.update_nodes_list=z,e.handle_nodes_scroll=Z,e.handle_window_scroll=W,e.is_mobile_layout=O}(),function(){"use strict";var e=window.RxOnly,t=e.app_state,n=e.dom_elements,C=e.config,P=e.field_maps;async function D(){e.save_read_position_before_leave(),e.clear_saved_scroll_position(),t.current_view="home",t.current_channel_index=null,t.current_channel_name=null,t.current_channel_url=null,t.current_node_url=null,n.app_layout.classList.remove("viewing-detail"),e.clear_sidebar_active(),e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"}]);var o=n.main_content.querySelector("#dashboard");if(!o){n.main_content.innerHTML="<p>Loading...</p>";try{var m=await e.fetch_stats(),h=e.populate_template("template-dashboard",m,P.dashboard);if(h){var p=h.querySelector(".dashboard-node-name"),v=h.querySelector(".dashboard-node-short"),E=m.local_node||{};p&&(E.long_name?p.textContent=E.long_name:E.short_name?p.textContent=E.short_name:E.node_id?p.textContent=E.node_id:p.textContent="Unknown Node"),v&&(E.long_name&&E.short_name?v.textContent=E.short_name:v.textContent=""),n.main_content.innerHTML="",n.main_content.appendChild(h)}e.update_page_title(m),z(m)}catch(H){n.main_content.innerHTML='<p class="error-state">Error loading dashboard: '+e.escape_html(H.message)+"</p>",e.update_page_title(null)}}}async function J(o,m){if(e.save_read_position_before_leave(),t.previous_view=t.current_view,t.previous_channel_index=t.current_channel_index,t.previous_channel_name=t.current_channel_name,t.previous_channel_url=t.current_channel_url,t.current_view="node",t.current_node_url=o,n.app_layout.classList.add("viewing-detail"),e.clear_sidebar_active(),n.nodes_list){var h=n.nodes_list.querySelector('.node-link[href="'+o+'"]');h&&h.classList.add("active")}n.main_content.innerHTML="<p>Loading...</p>";try{var p=await fetch(o),v=await p.json();if(!p.ok){var E=v.error||"Node not found";e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"}]),n.main_content.innerHTML='<p class="error-state">'+e.escape_html(E)+"</p>";return}var H=v.long_name||v.short_name||v.node_id,s=[{label:"Dashboard",href:"/",view:"home"}];m&&t.previous_view==="channel"&&t.previous_channel_name?s.push({label:t.previous_channel_name,href:t.previous_channel_url,view:"channel"}):m&&t.previous_view==="direct_messages"&&s.push({label:"Direct Messages",href:t.previous_channel_url,view:"direct_messages"}),s.push({label:H,href:o,view:"node"}),e.set_breadcrumbs(s);var r=e.populate_template("template-node-detail",v,P.node_detail);if(r){var _=r.querySelector("[data-field='heading']");if(_&&(_.textContent=e.format_node_display_name(v)),v.latitude!=null&&v.longitude!=null){var d=r.querySelector(".node-map-link"),i=r.querySelector("[data-field='map-link']");d&&i&&(i.href="https://www.openstreetmap.org/?mlat="+v.latitude+"&mlon="+v.longitude+"#map=9",d.removeAttribute("hidden"))}n.main_content.innerHTML="",n.main_content.appendChild(r)}}catch{e.set_breadcrumbs([{label:"Dashboard",href:"/",view:"home"}]),n.main_content.innerHTML='<p class="error-state">Error loading node</p>'}}function z(o){if(!(!o||!o.local_node)){var m=o.local_node;if(t.known_local_node_id===null){t.known_local_node_id=m.node_id,t.known_first_seen=m.first_seen;return}if(m.node_id!==t.known_local_node_id){console.log("Device changed, refreshing page..."),window.location.reload();return}if(m.first_seen!==t.known_first_seen){console.log("Database reset detected, refreshing page..."),window.location.reload();return}}}function Q(o){!o||!o.stats||e.update_all_node_counts(o.stats.total_nodes)}function Z(o){if(!(!o||!o.stats)){var m=o.stats,h=m.channel_counts||{};n.channels_list&&n.channels_list.querySelectorAll(".channel-link").forEach(function(p){var v=p.dataset.channelIndex,E=p.querySelector(".channel-count");if(E)if(v==="dm")E.textContent="("+m.total_direct_messages+")";else{var H=h[parseInt(v,10)]||0;E.textContent="("+H+")"}})}}function O(o){if(t.current_view==="home"&&!(!o||!o.stats)){var m=document.getElementById("dashboard");if(m){e.update_element(m,o,P.dashboard);var h=o.local_node||{},p=m.querySelector(".dashboard-node-name"),v=m.querySelector(".dashboard-node-short");p&&(h.long_name?p.textContent=h.long_name:h.short_name?p.textContent=h.short_name:h.node_id&&(p.textContent=h.node_id)),v&&(h.long_name&&h.short_name?v.textContent=h.short_name:v.textContent="")}}}async function W(){try{var o=await e.fetch_stats();t.poll_failure_count=0,I(),z(o),e.update_page_title(o),Q(o),Z(o),O(o)}catch(m){t.poll_failure_count++,console.error("Fast poll failed:",m),t.poll_failure_count>=C.max_poll_failures&&N()}}async function y(){if(!t.nodes_scroll_paused)try{await e.update_nodes_list()}catch(H){console.error("Slow poll (nodes) failed:",H)}if(!t.messages_scroll_paused){if(t.current_view==="channel"&&t.current_channel_index!==null)try{await q(!1)}catch(H){console.error("Slow poll (messages) failed:",H)}else if(t.current_view==="direct_messages")try{await q(!0)}catch(H){console.error("Slow poll (DMs) failed:",H)}}if(t.current_view==="node"&&t.current_node_url)try{var o=await fetch(t.current_node_url);if(o.ok){var m=await o.json(),h=document.querySelector(".node-detail");if(h){e.update_element(h,m,P.node_detail);var p=h.querySelector("[data-field='heading']");if(p&&(p.textContent=e.format_node_display_name(m)),m.latitude!=null&&m.longitude!=null){var v=h.querySelector(".node-map-link"),E=h.querySelector("[data-field='map-link']");v&&E&&(E.href="https://www.openstreetmap.org/?mlat="+m.latitude+"&mlon="+m.longitude+"#map=9",v.removeAttribute("hidden"))}}}}catch(H){console.error("Slow poll (node detail) failed:",H)}}async function q(o){var m=document.getElementById("messages-list");if(m&&!t.messages_is_loading&&t.messages_newest_rx_time!==null)try{var h=await e.fetch_message_page({is_dm:o,channel_index:o?null:t.current_channel_index,after_rx_time:t.messages_newest_rx_time}),p=o?h.direct_messages:h.messages;if(p.length>0){var v=p[p.length-1];t.messages_newest_rx_time=v.rx_time,t.messages_newest_id=v.id,e.append_messages_to_list(m,p,o)}t.messages_has_more_newer=h.meta.has_more_newer,t.messages_total=h.meta.total,e.update_jump_to_newest_button()}catch(E){console.error("Failed to update messages list:",E)}}function L(){F(),t.fast_poll_timer=setInterval(W,C.fast_poll_interval),t.slow_poll_timer=setInterval(y,C.slow_poll_interval)}function F(){t.fast_poll_timer&&(clearInterval(t.fast_poll_timer),t.fast_poll_timer=null),t.slow_poll_timer&&(clearInterval(t.slow_poll_timer),t.slow_poll_timer=null)}function N(){if(!document.getElementById("connection-error")){var o=document.createElement("div");o.id="connection-error",o.className="connection-error",o.textContent="Connection issue - retrying...",document.body.insertBefore(o,document.body.firstChild)}}function I(){var o=document.getElementById("connection-error");o&&o.remove()}async function T(o){var m=o.replace(/^#/,"");if(!m)return D(),!0;var h=m.split("/"),p=h[0],v=h.slice(1).join("/");if(p==="node"&&v){var E=e.build_node_url(v),H=t.navigating_from_content;return t.navigating_from_content=!1,J(E,H),!0}if(p==="channel"&&v){var s=parseInt(v,10);if(isNaN(s))return!1;var r=n.channels_list?n.channels_list.querySelector('.channel-link[data-channel-index="'+s+'"]'):null;if(!r)return!1;var _=r.querySelector(".channel-name"),d=_?_.textContent.trim():"Channel "+s,i=r.getAttribute("href"),f=await e.show_channel_messages(i,d,s);return f!==!1}if(p==="dm"&&!v){var g=n.channels_list?n.channels_list.querySelector('.channel-link[data-channel-index="dm"]'):null;if(!g)return!1;var x=g.getAttribute("href");return e.show_direct_messages(x),!0}return p==="dm"&&v?(e.show_message_detail(v,!0),!0):p==="message"&&v?(e.show_message_detail(v,!1),!0):!1}function Y(){var o=T(location.hash);o&&typeof o.then=="function"?o.then(function(m){m||(history.replaceState(null,"",location.pathname),D())}):o||(history.replaceState(null,"",location.pathname),D())}function M(o){var m=o.target.closest(".channel-link");if(m){o.preventDefault();var h=m.dataset.channelIndex;h==="dm"?location.hash="dm":location.hash="channel/"+h}}function A(o){var m=o.target.closest(".node-link");if(m){o.preventDefault();var h=m.dataset.nodeId;location.hash="node/"+h}}function w(o){!e.is_mobile_layout()&&n.nodes_list&&n.nodes_list.scrollTo({top:0,behavior:"smooth"})}function R(o){var m=o.target.closest("a");if(m){var h=m.dataset.view;if(o.preventDefault(),h==="home"){if(t.current_view==="home"&&t.breadcrumb_is_sticky){window.scrollTo({top:0,behavior:"smooth"});return}location.hash?location.hash="":D()}else if(h==="channel"){var p=t.current_channel_index!=null?t.current_channel_index:t.previous_channel_index;p!=null&&(location.hash="channel/"+p)}else h==="direct_messages"&&(location.hash="dm")}}function V(o){var m=o.target.closest(".message-reply-bar[data-reply-to-id]");if(m){o.preventDefault();var h=m.dataset.replyToId,p=t.current_view==="direct_messages";location.hash=(p?"dm/":"message/")+h;return}var v=o.target.closest(".message-detail-reply-to[data-reply-to-id]");if(v){o.preventDefault();var E=v.dataset.replyToId,H=t.current_view==="message"&&t.previous_view==="direct_messages";location.hash=(H?"dm/":"message/")+E;return}var s=o.target.closest(".tapback-pill[data-tapback-id]");if(s){o.preventDefault();var r=s.dataset.tapbackId,_=t.current_view==="direct_messages";location.hash=(_?"dm/":"message/")+r;return}var d=o.target.closest(".message-time-link");if(d){o.preventDefault();var i=d.closest("li[data-message-id]");if(i){var f=i.dataset.messageId,g=t.current_view==="direct_messages";location.hash=(g?"dm/":"message/")+f}return}var x=o.target.closest(".node-link");if(x){o.preventDefault(),t.navigating_from_content=!0;var S=x.dataset.nodeId;location.hash="node/"+S;return}}function j(){n.channels_list&&n.channels_list.addEventListener("click",M),n.nodes_list_heading&&n.nodes_list_heading.addEventListener("click",w),n.nodes_list&&(n.nodes_list.addEventListener("click",A),n.nodes_list.addEventListener("scroll",e.handle_nodes_scroll));var o=document.querySelector(".device-bar-home");o&&o.addEventListener("click",function(m){m.preventDefault(),location.hash?location.hash="":D()}),window.addEventListener("hashchange",Y),n.main_content&&n.main_content.addEventListener("click",V),n.nodes_search_input&&(n.nodes_search_input.addEventListener("input",e.handle_nodes_search_input),n.nodes_search_input.addEventListener("keydown",function(m){m.key==="Enter"&&(m.preventDefault(),t.nodes_search_debounce_timeout&&clearTimeout(t.nodes_search_debounce_timeout),t.nodes_search_query=n.nodes_search_input.value.trim(),n.nodes_search_clear&&(t.nodes_search_query===""?n.nodes_search_clear.setAttribute("hidden",""):n.nodes_search_clear.removeAttribute("hidden")),e.fetch_and_render_nodes_search())})),n.nodes_search_clear&&n.nodes_search_clear.addEventListener("click",e.clear_nodes_search),n.breadcrumbs_list&&n.breadcrumbs_list.addEventListener("click",R),e.setup_messages_scroll_listener(),window.addEventListener("scroll",function(){e.handle_window_scroll(),e.handle_messages_window_scroll(),e.handle_breadcrumb_scroll()},{passive:!0})}function U(){document.body.classList.remove("no-js"),j(),location.hash&&location.hash!=="#"?T(location.hash).then(function(o){o||(history.replaceState(null,"",location.pathname),D())}):D(),L()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",U):U()}();})();
